# SHACL-SD1002.TTL
# FDA Rule SD1002 for CJ16050
#
@prefix study: <https://w3id.org/phuse/study#> .
@prefix sh:   <http://www.w3.org/ns/shacl#>  .
@prefix time: <http://www.w3.org/2006/time#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix cj16050: <https://example.org/cj16050#> .

#------------------------------------------------------------------------------
# Rule Component 1
# Reference Start Date and End Date in xsd:date format
# Note:  Dates are associated with :hasBeginning or :hasEnd, other predicates
#        can be added for additional dates attached to different IRIs.
# Violations:
#   99T4  rfendtc as string
#   99T10 rfstdtc as string
# STATUS: Passed 2019-08-01
#------------------------------------------------------------------------------

:DateFmtShape a sh:NodeShape ;
  sh:targetObjectsOf time:hasBeginning ;
  sh:targetObjectsOf time:hasEnd ;
  sh:or (
    [ sh:class study:ReferenceBegin ]
    [ sh:class study:ReferenceEnd ]
  ) ;  
  sh:prefixes [
    sh:declare [ sh:prefix "cj16050" ;
      sh:namespace "https://example.org/cj16050#"^^xsd:anyURI ;
    ]
  ] ;
  sh:property [
    sh:path time:inXSDDate ;  
    sh:datatype xsd:date ;
  ] .  

#------------------------------------------------------------------------------
# Rule Component 2
# Subject has one reference interval 
# Violations:
#   99T11 No reference interval
# STATUS: Passed 2019-08-04
#------------------------------------------------------------------------------

:SubjectOneRefIntervalShape a sh:NodeShape ;
  sh:targetClass study:AnimalSubject ;
  sh:path study:hasReferenceInterval ;
  sh:minCount 1 ;
  sh:maxCount 1 .

#------------------------------------------------------------------------------
# Rule Component 3
# Reference Interval has one Start Date and one End Date
# Violations:  
#   99T5 missing rfendtc
#   99T9 missing rfstdtc
#   99T8 missing both rfendtc, rfstdtc
#   99T2 >1 rfstdtc, >1 rfendtc  
# STATUS: Passed 2019-08-04
#------------------------------------------------------------------------------

:RefIntervalDateShape a sh:NodeShape ;
  sh:targetClass study:ReferenceInterval ;
  sh:and (
    [ sh:path time:hasBeginning ;
      sh:minCount 1;
      sh:maxCount 1
    ]
    [
      sh:path time:hasEnd ;
      sh:minCount 1;
      sh:maxCount 1
    ]
 )
.

# Rule Component 4
# SD1002: Start Date on or before End Date
# Violations:
#  99T1  start precedes end
#  99T2  multiple start/end values, one start is before one end value
#  99T10 String value for rfstdtc strips violation in comparision with rfendtc
# STATUS: Passed 2019-08-04

:SD1002RuleShape a sh:NodeShape ;
 sh:targetClass study:ReferenceInterval ;
 sh:sparql [
  a sh:SPARQLConstraint ;
  sh:message "RFSTDTC is after RFENDTC";
  sh:prefixes [
    sh:declare [ sh:prefix "time" ;
      sh:namespace "http://www.w3.org/2006/time#"^^xsd:anyURI ;
    ],
    [ sh:prefix "study" ;
      sh:namespace "https://w3id.org/phuse/study#"^^xsd:anyURI ;
    ]  
  ] ;
 sh:select
  """SELECT $this (?beginDate AS ?intervalStart) (?endDate AS ?intervalEnd)
    WHERE {
      $this     time:hasBeginning  ?beginIRI ;
                time:hasEnd        ?endIRI .
      ?beginIRI time:inXSDDate     ?beginDate .
      ?endIRI   time:inXSDDate     ?endDate .
      FILTER  (! (?endDate >= ?beginDate ))
    }""" ;
] .

:DateFmtShape               sh:deactivated false .
:SubjectOneRefIntervalShape sh:deactivated false .
:RefIntervalDateShape       sh:deactivated false .
:SD1002RuleShape            sh:deactivated false .
